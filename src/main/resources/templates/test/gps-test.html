<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        h1 { font-size: 24px; font-weight: 700; color: #1F2937; margin-bottom: 8px; }
        .subtitle { font-size: 14px; color: #6B7280; margin-bottom: 20px; }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .status.waiting { background: #FEF3C7; color: #92400E; }
        .status.active { background: #D1FAE5; color: #065F46; animation: pulse 2s infinite; }
        .status.error { background: #FEE2E2; color: #991B1B; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-start { background: linear-gradient(90deg, #10B981 0%, #059669 100%); color: white; }
        .btn-stop { background: linear-gradient(90deg, #EF4444 0%, #DC2626 100%); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #E5E7EB;
        }
        .data-row:last-child { border-bottom: none; }
        .data-label { font-size: 14px; color: #6B7280; }
        .data-value { font-size: 16px; font-weight: 600; color: #1F2937; }
        .data-value.good { color: #10B981; }
        .data-value.warning { color: #F59E0B; }
        .data-value.error { color: #EF4444; }
        .big-stat { text-align: center; margin: 20px 0; }
        .big-stat-label { font-size: 12px; color: #6B7280; margin-bottom: 8px; }
        .big-stat-value { font-size: 48px; font-weight: 700; color: #10B981; }
        .big-stat-unit { font-size: 16px; color: #9CA3AF; margin-left: 4px; }
        .log-container {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry { padding: 4px 0; color: #4B5563; }
        .log-entry.success { color: #10B981; }
        .log-entry.error { color: #EF4444; }
        .log-entry.warning { color: #F59E0B; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ“ GPS ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h1>
            <p class="subtitle">1ì´ˆë§ˆë‹¤ ê°•ì œë¡œ GPS ìƒˆë¡œ ìš”ì²­ (getCurrentPosition)</p>
            <div id="status" class="status waiting">â¸ï¸ ëŒ€ê¸° ì¤‘</div>
            <button id="startBtn" class="btn btn-start">GPS ì¶”ì  ì‹œì‘</button>
            <button id="stopBtn" class="btn btn-stop" style="display: none;">GPS ì¶”ì  ì¤‘ì§€</button>
        </div>

        <div class="card">
            <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">ğŸ“ í˜„ì¬ ìœ„ì¹˜ (ì‹¤ì‹œê°„)</h2>
            <div class="data-row">
                <span class="data-label">ìœ„ë„ (Latitude)</span>
                <span class="data-value" id="latitude">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">ê²½ë„ (Longitude)</span>
                <span class="data-value" id="longitude">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">ì •í™•ë„ (Accuracy)</span>
                <span class="data-value" id="accuracy">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">ì†ë„ (Speed)</span>
                <span class="data-value" id="speed">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">ì—…ë°ì´íŠ¸ íšŸìˆ˜</span>
                <span class="data-value" id="updateCount">0</span>
            </div>
            <div class="data-row">
                <span class="data-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</span>
                <span class="data-value" id="lastUpdate">--</span>
            </div>
        </div>

        <div class="card">
            <div class="big-stat">
                <div class="big-stat-label">ì´ ì´ë™ ê±°ë¦¬</div>
                <div>
                    <span class="big-stat-value" id="totalDistance">0.000</span>
                    <span class="big-stat-unit">km</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">ğŸ“‹ ë¡œê·¸</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
            </div>
        </div>
    </div>

    <script src="/js/api-common.js" th:src="@{/js/api-common.js}"></script>
<script>
        // â­ í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹: watchPosition + 1ì´ˆ í´ë§
        let watchId = null;        // watchPosition ID
        let pollTimer = null;      // 1ì´ˆ í´ë§ íƒ€ì´ë¨¸
        let isTracking = false;
        let lastPosition = null;
        let currentPosition = null; // ìµœì‹  GPS ìœ„ì¹˜ ì €ì¥
        let totalDistance = 0;
        let updateCount = 0;
        let lastUpdateTime = 0;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const latitudeEl = document.getElementById('latitude');
        const longitudeEl = document.getElementById('longitude');
        const accuracyEl = document.getElementById('accuracy');
        const speedEl = document.getElementById('speed');
        const totalDistanceEl = document.getElementById('totalDistance');
        const updateCountEl = document.getElementById('updateCount');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const logContainer = document.getElementById('logContainer');

        // GPS ì¶”ì  ì‹œì‘
        startBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                addLog('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            addLog('ğŸš€ GPS ì¶”ì  ì‹œì‘... (1ì´ˆë§ˆë‹¤ ê°•ì œ ìš”ì²­)', 'success');
            
            // â­ 1ì´ˆë§ˆë‹¤ getCurrentPositionìœ¼ë¡œ ê°•ì œ ìš”ì²­!
            pollTimer = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = position;
                        lastUpdateTime = Date.now();
                        
                        // í™”ë©´ ê°±ì‹ 
                        const now = new Date();
                        lastUpdateEl.textContent = now.toLocaleTimeString('ko-KR');
                        
                        console.log('ğŸ“¡ GPS ìˆ˜ì‹ :', position.coords.accuracy.toFixed(1) + 'm');
                        
                        // ë°”ë¡œ ì²˜ë¦¬
                        processGPS(position);
                    },
                    onGPSError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0  // â­ ìºì‹œ ì ˆëŒ€ ì‚¬ìš© ì•ˆ í•¨!
                    }
                );
            }, 1000);  // â­ 1ì´ˆë§ˆë‹¤!

            isTracking = true;
            updateCount = 0;
            totalDistance = 0;
            lastPosition = null;
            currentPosition = null;
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            statusEl.textContent = 'âœ… GPS ì¶”ì  ì¤‘';
            statusEl.className = 'status active';
        });

        // GPS ì¶”ì  ì¤‘ì§€
        stopBtn.addEventListener('click', function() {
            stopTracking();
            addLog('ğŸ›‘ GPS ì¶”ì  ì¤‘ì§€ë¨', 'warning');
        });

        // â­ GPS ìˆ˜ì‹  (ì €ì¥ë§Œ, ì²˜ë¦¬ëŠ” 1ì´ˆë§ˆë‹¤)
        function onGPSReceive(position) {
            if (!isTracking) return;
            
            // ìµœì‹  GPS ìœ„ì¹˜ ì €ì¥
            currentPosition = position;
            lastUpdateTime = Date.now();
            
            // í™”ë©´ ê°±ì‹  (ì—…ë°ì´íŠ¸ ì‹œê°„)
            const now = new Date();
            lastUpdateEl.textContent = now.toLocaleTimeString('ko-KR');
            
            console.log('ğŸ“¡ GPS ìˆ˜ì‹ :', position.coords.accuracy.toFixed(1) + 'm');
        }

        // â­ GPS ì²˜ë¦¬ (1ì´ˆë§ˆë‹¤ ì‹¤í–‰)
        function processGPS(position) {
            if (!isTracking) return;
            
            updateCount++;
            updateCountEl.textContent = updateCount;
            
            const coords = position.coords;
            
            // â­ ë¡œê·¸: ìœ„ê²½ë„ + ì •í™•ë„
            console.log(`ğŸ”„ GPS ì²˜ë¦¬ #${updateCount}`,
                        `ìœ„ë„: ${coords.latitude.toFixed(6)},`,
                        `ê²½ë„: ${coords.longitude.toFixed(6)},`,
                        `ì •í™•ë„: ${coords.accuracy.toFixed(1)}m`);
            
            // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
            latitudeEl.textContent = coords.latitude.toFixed(6);
            longitudeEl.textContent = coords.longitude.toFixed(6);
            
            // ì •í™•ë„ í‘œì‹œ
            accuracyEl.textContent = coords.accuracy.toFixed(1) + 'm';
            if (coords.accuracy < 10) {
                accuracyEl.className = 'data-value good';
            } else if (coords.accuracy < 100) {  // â­ 50m â†’ 100më¡œ ì™„í™”
                accuracyEl.className = 'data-value warning';
            } else {
                accuracyEl.className = 'data-value error';
            }
            
            // ì†ë„ í‘œì‹œ
            if (coords.speed !== null && coords.speed !== undefined && coords.speed > 0) {
                const speedKmh = (coords.speed * 3.6).toFixed(1);
                speedEl.textContent = speedKmh + ' km/h';
            } else {
                speedEl.textContent = '0 km/h';
            }

            // ê±°ë¦¬ ê³„ì‚°
            if (lastPosition) {
                const distance = calculateDistance(
                    lastPosition.coords.latitude,
                    lastPosition.coords.longitude,
                    coords.latitude,
                    coords.longitude
                );

                // â­ ë¡œê·¸: ê±°ë¦¬ ë³€í™”ëŸ‰ í•­ìƒ í‘œì‹œ
                console.log(`ğŸ“ ê±°ë¦¬ ë³€í™”: ${(distance * 1000).toFixed(2)}m`);

                if (distance < 1.0) {  
                    totalDistance += distance;
                    totalDistanceEl.textContent = totalDistance.toFixed(3);
                    
                    // â­ ëª¨ë“  ì´ë™ ë¡œê·¸ (ì¡°ê±´ ì œê±°)
                    addLog(`âœ… #${updateCount} ìœ„ë„:${coords.latitude.toFixed(6)} ê²½ë„:${coords.longitude.toFixed(6)} +${(distance * 1000).toFixed(2)}m (ì´:${totalDistance.toFixed(3)}km)`, 'success');
                } else {
                    addLog(`âš ï¸ #${updateCount} GPS ì í”„: ${(distance * 1000).toFixed(1)}m - ë¬´ì‹œ`, 'warning');
                }
            } else {
                addLog(`ğŸ“ ì²« GPS: ìœ„ë„:${coords.latitude.toFixed(6)}, ê²½ë„:${coords.longitude.toFixed(6)} (ì •í™•ë„:${coords.accuracy.toFixed(1)}m)`, 'success');
            }

            lastPosition = position;
        }

        // GPS ì—ëŸ¬ ì½œë°±
        function onGPSError(error) {
            let errorMsg = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'âŒ GPS ê¶Œí•œ ê±°ë¶€ë¨';
                    alert('GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!');
                    stopTracking();
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'âš ï¸ GPS ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'âš ï¸ GPS íƒ€ì„ì•„ì›ƒ';
                    break;
                default:
                    errorMsg = 'âŒ ì•Œ ìˆ˜ ì—†ëŠ” GPS ì˜¤ë¥˜';
            }

            addLog(errorMsg, 'error');
            console.error('GPS ì—ëŸ¬:', error);
        }

        // ê±°ë¦¬ ê³„ì‚° (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function toRad(degrees) {
            return degrees * (Math.PI / 180);
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = '') {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            logEntry.textContent = '[' + timestamp + '] ' + message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ì¶”ì  ì¤‘ì§€
        function stopTracking() {
            if (pollTimer !== null) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            isTracking = false;
            currentPosition = null;
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            statusEl.textContent = 'â¸ï¸ ëŒ€ê¸° ì¤‘';
            statusEl.className = 'status waiting';
        }
    </script>

</body>
</html>
