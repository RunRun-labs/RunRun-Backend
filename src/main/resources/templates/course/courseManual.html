<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RUNRUN | ÏàòÎèô ÏΩîÏä§ Îì±Î°ù</title>
    <script src="/js/api-common.js" th:src="@{/js/api-common.js}"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=477a1cea9ecc7c2b3e69f3540a3986b4&libraries=services"></script>
    <style>
      :root {
        font-family: "Nunito Sans", "Noto Sans KR", sans-serif;
        --primary: #baff29;
        --bg: #f7f7f9;
        --text: #1a1c1e;
        --muted: #6c7278;
        --danger: #ff3d00;
        --active: #4CAF50;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow: hidden;
      }

      .page {
        max-width: 520px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 18px;
        background: #fff;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      header h1 {
        font-size: 16px;
        font-weight: 800;
        margin: 0;
        flex: 1;
        text-align: center;
      }

      .icon-btn {
        border: none;
        border-radius: 999px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
        background: rgba(0, 0, 0, 0.05);
      }

      .apply-btn {
        border: none;
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        background: var(--primary);
        padding: 8px 20px;
        color: #000;
      }

      .apply-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      #map {
        flex: 1;
        min-height: 100vh;
        position: relative;
        overflow: hidden;
      }

      /* Í≤ÄÏÉâ Ìå®ÎÑê */
      .search-panel {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 180px);
        max-width: 400px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 12;
        overflow: visible;
      }

      .search-input-wrapper {
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 16px 48px 16px 48px;
        border: none;
        font-size: 15px;
        outline: none;
        border-radius: 16px;
      }

      .search-input::placeholder {
        color: #999;
      }

      .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 18px;
      }

      .clear-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: #e0e0e0;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        color: #666;
      }

      .search-input:not(:placeholder-shown) ~ .clear-icon {
        display: flex;
      }

      /* Í≤ÄÏÉâ Í≤∞Í≥º Î¶¨Ïä§Ìä∏ */
      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        display: none;
        margin-top: 4px;
        z-index: 1000;
      }

      .search-results.show {
        display: block;
      }

      .search-result-item {
        padding: 14px 16px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .search-result-item:hover {
        background: #f8f8f8;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .result-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #000;
      }

      .result-address {
        font-size: 13px;
        color: #666;
      }

      .result-category {
        font-size: 11px;
        color: #999;
        margin-top: 2px;
      }

      .no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 13px;
      }

      /* ÏôºÏ™Ω Ïª®Ìä∏Î°§ Ìå®ÎÑê */
      .control-panel {
        position: fixed;
        left: 20px;
        top: 100px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 10;
      }

      /* ÎèôÍ∑∏ÎûÄ Î≤ÑÌäº */
      .round-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.2s;
        position: relative;
      }

      .round-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      .round-btn:active {
        transform: scale(0.95);
      }

      .round-btn.active {
        background: var(--active);
        color: white;
      }

      .round-btn.danger {
        background: var(--danger);
        color: white;
      }

      /* Ìà¥ÌåÅ */
      .round-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 70px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }

      .round-btn:hover::after {
        opacity: 1;
      }

      /* Í≤ΩÎ°ú ÏÉùÏÑ± Î≤ÑÌäº */
      .create-route-btn {
        position: fixed;
        bottom: calc(80px + env(safe-area-inset-bottom, 0px));
        left: 50%;
        transform: translateX(-50%);
        padding: 18px 48px;
        background: var(--primary);
        border: none;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        display: none;
        box-shadow: 0 8px 24px rgba(186, 255, 41, 0.5);
        transition: all 0.3s;
        z-index: 15;
        max-width: calc(100% - 40px);
        white-space: nowrap;
      }

      .create-route-btn.show {
        display: block;
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }

      .create-route-btn:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 12px 32px rgba(186, 255, 41, 0.6);
      }

      .create-route-btn:active {
        transform: translateX(-50%) translateY(0);
      }

      /* Í≤∞Í≥º Î™®Îã¨ */
      .result-modal {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 520px;
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        z-index: 20;
        display: none;
        padding: 20px;
        max-height: 40vh;
        overflow-y: auto;
      }

      .result-modal.show {
        display: block;
      }

      .modal-handle {
        width: 40px;
        height: 4px;
        background: #ddd;
        border-radius: 2px;
        margin: 0 auto 16px;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 12px;
      }

      .modal-info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .modal-info-row:last-child {
        border-bottom: none;
      }

      .modal-info-label {
        color: #666;
        font-size: 14px;
      }

      .modal-info-value {
        font-weight: 600;
        font-size: 14px;
      }

      .modal-buttons {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
      }

      .modal-button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
      }

      .modal-button.cancel {
        background: #f0f0f0;
        color: #666;
      }

      /* Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }

      .loading-overlay.show {
        display: flex;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f0f0f0;
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Î∞òÏùëÌòï */
      @media (max-width: 520px) {
        .control-panel {
          left: 12px;
          top: 90px;
          gap: 10px;
        }

        .round-btn {
          width: 50px;
          height: 50px;
          font-size: 20px;
        }

        .create-route-btn {
          padding: 16px 40px;
          font-size: 15px;
        }

        .distance-display {
          right: 12px;
          top: 140px; /* Î™®Î∞îÏùºÏóêÏÑú Í≤ÄÏÉâÏ∞Ω ÏïÑÎûòÎ°ú */
        }
      }

      /* Ïã§ÏãúÍ∞Ñ Í±∞Î¶¨ ÌëúÏãú */
      .distance-display {
        position: fixed;
        right: 20px;
        top: 150px; /* Í≤ÄÏÉâÏ∞Ω ÏïÑÎûòÎ°ú Ïù¥Îèô */
        background: white;
        padding: 16px 20px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10;
        text-align: center;
      }

      .distance-value {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .distance-label {
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <button class="icon-btn" type="button" onclick="history.back()">
          Îí§Î°ú
        </button>
        <h1>ÏàòÎèô Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞</h1>
        <button class="apply-btn" id="applyBtn" disabled>Ï†ÅÏö©</button>
      </header>

      <div id="map">
        <!-- Í≤ÄÏÉâ Ìå®ÎÑê -->
        <div class="search-panel">
          <div class="search-input-wrapper">
            <span class="search-icon">üîç</span>
            <input
              id="locationSearch"
              class="search-input"
              placeholder="ÏãúÏûë ÏúÑÏπòÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî"
              autocomplete="off"
            />
            <button class="clear-icon" id="clearSearch">√ó</button>
            <div class="search-results" id="searchResults"></div>
          </div>
        </div>

        <!-- ÏôºÏ™Ω Ïª®Ìä∏Î°§ Ìå®ÎÑê -->
        <div class="control-panel">
          <button class="round-btn" id="drawModeBtn" data-tooltip="ÏÑ† Í∑∏Î¶¨Í∏∞">
            ‚úèÔ∏è
          </button>
          <button class="round-btn" id="pointModeBtn" data-tooltip="Ï†ê Ï∞çÍ∏∞">
            üìç
          </button>
          <button class="round-btn" id="undoPointBtn" data-tooltip="Ìïú Ï†ê ÎêòÎèåÎ¶¨Í∏∞">
            ‚Ü©Ô∏è
          </button>
          <button class="round-btn" id="undoLineBtn" data-tooltip="Ìïú ÏÑ† ÎêòÎèåÎ¶¨Í∏∞">
            ‚§¥Ô∏è
          </button>
          <button class="round-btn" id="roundTripBtn" data-tooltip="ÏôïÎ≥µ Î™®Îìú">
            üîÑ
          </button>
          <button class="round-btn" id="clearPointsBtn" data-tooltip="Ï∞çÏùÄ Ï†êÎßå ÏßÄÏö∞Í∏∞">
            üóëÔ∏è
          </button>
          <button class="round-btn danger" id="clearAllBtn" data-tooltip="Ï†ÑÏ≤¥ ÏßÄÏö∞Í∏∞">
            üö´
          </button>
        </div>

        <!-- Ïã§ÏãúÍ∞Ñ Í±∞Î¶¨ ÌëúÏãú -->
        <div class="distance-display" id="distanceDisplay" style="display: none;">
          <div class="distance-value" id="distanceValue">0.00 km</div>
          <div class="distance-label">ÌòÑÏû¨ Í±∞Î¶¨</div>
        </div>

        <!-- Í≤ΩÎ°ú ÏÉùÏÑ± Î≤ÑÌäº -->
        <button class="create-route-btn" id="createRouteBtn">
          üöÄ Í≤ΩÎ°ú ÏÉùÏÑ±
        </button>

        <!-- Í≤∞Í≥º Î™®Îã¨ -->
        <div class="result-modal" id="resultModal">
          <div class="modal-handle"></div>
          <div class="modal-title">Í≤ΩÎ°ú Ï†ïÎ≥¥</div>
          <div class="modal-info-row">
            <span class="modal-info-label">Í±∞Î¶¨</span>
            <span class="modal-info-value" id="modalDistance">-</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Ï¢åÌëú Ïàò</span>
            <span class="modal-info-value" id="modalPoints">-</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Ï∂úÎ∞úÏßÄ</span>
            <span class="modal-info-value" id="modalStart">-</span>
          </div>
          <div class="modal-buttons">
            <button class="modal-button cancel" id="cancelBtn">Îã§Ïãú Í∑∏Î¶¨Í∏∞</button>
          </div>
        </div>

        <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <script th:inline="none">
      const MAX_DISTANCE_M = 42195;
      const STORAGE_KEY = "courseDraft";
      const API_BASE = "";

      const applyBtn = document.getElementById("applyBtn");
      const drawModeBtn = document.getElementById("drawModeBtn");
      const pointModeBtn = document.getElementById("pointModeBtn");
      const undoPointBtn = document.getElementById("undoPointBtn");
      const undoLineBtn = document.getElementById("undoLineBtn");
      const roundTripBtn = document.getElementById("roundTripBtn");
      const clearPointsBtn = document.getElementById("clearPointsBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const createRouteBtn = document.getElementById("createRouteBtn");
      const resultModal = document.getElementById("resultModal");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const cancelBtn = document.getElementById("cancelBtn");
      const distanceDisplay = document.getElementById("distanceDisplay");
      const distanceValue = document.getElementById("distanceValue");
      const locationSearch = document.getElementById("locationSearch");
      const searchResults = document.getElementById("searchResults");
      const clearSearch = document.getElementById("clearSearch");

      const map = new kakao.maps.Map(document.getElementById("map"), {
        center: new kakao.maps.LatLng(37.5665, 126.978),
        level: 5,
        draggable: true,
        scrollwheel: true,
      });
      const geocoder = new kakao.maps.services.Geocoder();
      const ps = new kakao.maps.services.Places();

      let drawing = false;
      let pointMode = false;
      let roundTripMode = false; // ÏôïÎ≥µ Î™®Îìú
      let points = [];
      let lineSegments = []; // ÏÑ†Î∂Ñ Í∏∞Î°ù (Ìïú ÏÑ† ÎêòÎèåÎ¶¨Í∏∞Ïö©)
      let poiMarkers = [];
      let startMarker = null;
      let polyline = null;
      let startAddress = "";
      let generatedLineString = null;
      let totalDistanceM = 0;

      function showLoading() {
        loadingOverlay.classList.add("show");
      }

      function hideLoading() {
        loadingOverlay.classList.remove("show");
      }

      function haversine(a, b) {
        const R = 6371000;
        const dLat = ((b.lat - a.lat) * Math.PI) / 180;
        const dLng = ((b.lng - a.lng) * Math.PI) / 180;
        const lat1 = (a.lat * Math.PI) / 180;
        const lat2 = (b.lat * Math.PI) / 180;
        const c =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.atan2(Math.sqrt(c), Math.sqrt(1 - c));
      }

      function calcDistance(coords) {
        if (!coords || coords.length < 2) return 0;
        let sum = 0;
        for (let i = 1; i < coords.length; i++) {
          sum += haversine(coords[i - 1], coords[i]);
        }
        return sum;
      }

      function updateDistanceDisplay() {
        const distance = calcDistance(points);
        if (points.length >= 2) {
          distanceDisplay.style.display = "block";
          distanceValue.textContent = (distance / 1000).toFixed(2) + " km";
        } else {
          distanceDisplay.style.display = "none";
        }
      }

      function drawPolyline(coords) {
        if (polyline) {
          polyline.setMap(null);
        }
        const path = coords.map((p) => new kakao.maps.LatLng(p.lat, p.lng));
        polyline = new kakao.maps.Polyline({
          path: path,
          strokeWeight: 6,
          strokeColor: "#ff3d00",
          strokeOpacity: 0.8,
        });
        polyline.setMap(map);
        // ÏßÄÎèÑ Î≤îÏúÑ Ï°∞Ï†ï Ï†úÍ±∞ - ÏÇ¨Ïö©ÏûêÍ∞Ä Î≥¥Í≥† ÏûàÎäî ÌôîÎ©¥ Ïú†ÏßÄ
      }

      function clearPoiMarkers() {
        poiMarkers.forEach((m) => m.setMap(null));
        poiMarkers = [];
      }

      async function reverseGeocode(lat, lng) {
        return new Promise((resolve) => {
          geocoder.coord2Address(lng, lat, (result, status) => {
            if (status === kakao.maps.services.Status.OK && result?.[0]) {
              const addr =
                result[0].road_address?.address_name ??
                result[0].address?.address_name ??
                "";
              resolve(addr);
            } else {
              resolve("");
            }
          });
        });
      }

      function checkIfCanGenerate() {
        const hasPoints = points.length >= 2;
        const hasPoiMarkers = poiMarkers.length >= 2;
        if (hasPoints || hasPoiMarkers) {
          createRouteBtn.classList.add("show");
        } else {
          createRouteBtn.classList.remove("show");
        }
      }

      // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
      function showSearchResults(results) {
        searchResults.innerHTML = "";
        
        if (!results || results.length === 0) {
          searchResults.innerHTML = '<div class="no-results">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
          searchResults.classList.add("show");
          return;
        }

        results.forEach((place) => {
          const item = document.createElement("div");
          item.className = "search-result-item";
          
          const categoryText = place.category_name ? 
            `<div class="result-category">${place.category_name}</div>` : '';
          
          item.innerHTML = `
            <div class="result-name">${place.place_name}</div>
            <div class="result-address">${
              place.road_address_name || place.address_name
            }</div>
            ${categoryText}
          `;
          item.addEventListener("click", () => {
            const lat = Number(place.y);
            const lng = Number(place.x);
            map.setCenter(new kakao.maps.LatLng(lat, lng));
            map.setLevel(3);
            locationSearch.value = place.place_name;
            searchResults.classList.remove("show");
          });
          searchResults.appendChild(item);
        });
        searchResults.classList.add("show");
      }

      // Í≤ÄÏÉâ Ìï®Ïàò
      let searchTimeout = null;
      function searchPlaces(keyword) {
        if (!keyword || !keyword.trim()) {
          searchResults.innerHTML = "";
          searchResults.classList.remove("show");
          return;
        }
        
        ps.keywordSearch(keyword, (data, status) => {
          if (status === kakao.maps.services.Status.OK) {
            showSearchResults(data.slice(0, 10));
          } else {
            showSearchResults([]);
          }
        });
      }

      // ÏúÑÏπò Í≤ÄÏÉâ ÏûÖÎ†•
      locationSearch.addEventListener("input", (e) => {
        const keyword = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (!keyword) {
          searchResults.innerHTML = "";
          searchResults.classList.remove("show");
          return;
        }
        
        searchTimeout = setTimeout(() => {
          searchPlaces(keyword);
        }, 200);
      });

      // Í≤ÄÏÉâ ÏßÄÏö∞Í∏∞
      clearSearch.addEventListener("click", () => {
        locationSearch.value = "";
        searchResults.innerHTML = "";
        searchResults.classList.remove("show");
      });

      // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Í≤ÄÏÉâ Í≤∞Í≥º Îã´Í∏∞
      document.addEventListener("click", (e) => {
        if (!locationSearch.contains(e.target) && !searchResults.contains(e.target) && e.target !== clearSearch) {
          searchResults.classList.remove("show");
        }
      });

      // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      kakao.maps.event.addListener(map, "click", async (mouseEvent) => {
        const latlng = mouseEvent.latLng;
        const lat = latlng.getLat();
        const lng = latlng.getLng();

        if (pointMode) {
          // Ï†ê Ï∞çÍ∏∞ Î™®Îìú
          const marker = new kakao.maps.Marker({ position: latlng, map });
          poiMarkers.push(marker);
          checkIfCanGenerate();
          return;
        }

        if (!drawing) {
          return;
        }

        // ÏÑ† Í∑∏Î¶¨Í∏∞ Î™®Îìú
        const newPoint = { lat, lng };
        
        // lineSegmentsÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÎßàÏßÄÎßâ ÏÑ†Î∂ÑÏù¥ ÏóÜÏúºÎ©¥ ÏÉà ÏÑ†Î∂Ñ ÏãúÏûë
        if (lineSegments.length === 0) {
          lineSegments.push([newPoint]);
        } else {
          // ÌòÑÏû¨ ÏÑ†Î∂ÑÏóê Ï†ê Ï∂îÍ∞Ä
          lineSegments[lineSegments.length - 1].push(newPoint);
        }
        
        points.push(newPoint);

        if (points.length === 1) {
          // Ï≤´ Ï†ê - ÏãúÏûë ÎßàÏª§
          if (startMarker) startMarker.setMap(null);
          startMarker = new kakao.maps.Marker({ position: latlng, map });
          startAddress = await reverseGeocode(lat, lng);
        }

        // ÏßÄÎèÑ Ï§ëÏã¨ Ïù¥ÎèôÌïòÏßÄ ÏïäÍ≥† ÏÑ†Îßå Í∑∏Î¶¨Í∏∞
        if (polyline) {
          polyline.setMap(null);
        }
        const path = points.map((p) => new kakao.maps.LatLng(p.lat, p.lng));
        polyline = new kakao.maps.Polyline({
          path: path,
          strokeWeight: 6,
          strokeColor: "#ff3d00",
          strokeOpacity: 0.8,
        });
        polyline.setMap(map);
        
        console.log("Points:", points.length, "LineSegments:", lineSegments.map(s => s.length));
        updateDistanceDisplay();
        checkIfCanGenerate();
      });

      // ÏÑ† Í∑∏Î¶¨Í∏∞ Î™®Îìú ÌÜ†Í∏Ä
      drawModeBtn.addEventListener("click", () => {
        drawing = !drawing;
        if (drawing) {
          drawModeBtn.classList.add("active");
          pointMode = false;
          pointModeBtn.classList.remove("active");
          // ÏÉàÎ°úÏö¥ ÏÑ†Î∂Ñ ÏãúÏûë - Ïù¥Ï†Ñ Ï†êÎì§Ïù¥ ÏûàÍ≥† ÎßàÏßÄÎßâ ÏÑ†Î∂ÑÏù¥ ÎπÑÏñ¥ÏûàÏßÄ ÏïäÏùÑ ÎïåÎßå
          if (points.length > 0 && lineSegments.length > 0) {
            const lastSegment = lineSegments[lineSegments.length - 1];
            if (lastSegment.length > 0) {
              lineSegments.push([]);
            }
          }
        } else {
          drawModeBtn.classList.remove("active");
        }
      });

      // Ï†ê Ï∞çÍ∏∞ Î™®Îìú
      pointModeBtn.addEventListener("click", () => {
        pointMode = !pointMode;
        if (pointMode) {
          pointModeBtn.classList.add("active");
          drawing = false;
          drawModeBtn.classList.remove("active");
        } else {
          pointModeBtn.classList.remove("active");
        }
      });

      // ÏôïÎ≥µ Î™®Îìú ÌÜ†Í∏Ä
      roundTripBtn.addEventListener("click", () => {
        roundTripMode = !roundTripMode;
        if (roundTripMode) {
          roundTripBtn.classList.add("active");
        } else {
          roundTripBtn.classList.remove("active");
        }
      });

      // Ìïú Ï†ê ÎêòÎèåÎ¶¨Í∏∞
      undoPointBtn.addEventListener("click", () => {
        if (points.length === 0) return;
        
        points.pop();
        
        // ÌòÑÏû¨ ÏÑ†Î∂ÑÏóêÏÑúÎèÑ Ï†úÍ±∞
        if (lineSegments.length > 0) {
          const currentSegment = lineSegments[lineSegments.length - 1];
          if (currentSegment.length > 0) {
            currentSegment.pop();
            // ÏÑ†Î∂ÑÏù¥ ÎπÑÏóàÏúºÎ©¥ Ï†úÍ±∞
            if (currentSegment.length === 0) {
              lineSegments.pop();
            }
          }
        }
        
        if (points.length === 0) {
          if (startMarker) {
            startMarker.setMap(null);
            startMarker = null;
          }
          startAddress = "";
          if (polyline) {
            polyline.setMap(null);
            polyline = null;
          }
          lineSegments = [];
        } else {
          // ÏßÄÎèÑ Ï§ëÏã¨ Ïù¥Îèô ÏóÜÏù¥ ÏÑ†Îßå Îã§Ïãú Í∑∏Î¶¨Í∏∞
          if (polyline) {
            polyline.setMap(null);
          }
          const path = points.map((p) => new kakao.maps.LatLng(p.lat, p.lng));
          polyline = new kakao.maps.Polyline({
            path: path,
            strokeWeight: 6,
            strokeColor: "#ff3d00",
            strokeOpacity: 0.8,
          });
          polyline.setMap(map);
        }
        
        updateDistanceDisplay();
        checkIfCanGenerate();
      });

      // Ìïú ÏÑ† ÎêòÎèåÎ¶¨Í∏∞
      undoLineBtn.addEventListener("click", () => {
        if (lineSegments.length === 0) {
          console.log("ÏÑ†Î∂ÑÏù¥ ÏóÜÏäµÎãàÎã§.");
          return;
        }
        
        console.log("Before undo - Points:", points.length, "LineSegments:", lineSegments.map(s => s.length));
        
        // ÎßàÏßÄÎßâ ÏÑ†Î∂Ñ Ï†úÍ±∞
        const lastSegment = lineSegments.pop();
        console.log("Removing segment with", lastSegment.length, "points");
        
        // pointsÏóêÏÑúÎèÑ Ìï¥Îãπ ÏÑ†Î∂ÑÏùò Ï†êÎì§ Ï†úÍ±∞
        for (let i = 0; i < lastSegment.length; i++) {
          points.pop();
        }
        
        console.log("After undo - Points:", points.length, "LineSegments:", lineSegments.map(s => s.length));
        
        if (points.length === 0) {
          if (startMarker) {
            startMarker.setMap(null);
            startMarker = null;
          }
          startAddress = "";
          if (polyline) {
            polyline.setMap(null);
            polyline = null;
          }
          lineSegments = [];
        } else {
          // ÏßÄÎèÑ Ï§ëÏã¨ Ïù¥Îèô ÏóÜÏù¥ ÏÑ†Îßå Îã§Ïãú Í∑∏Î¶¨Í∏∞
          if (polyline) {
            polyline.setMap(null);
          }
          const path = points.map((p) => new kakao.maps.LatLng(p.lat, p.lng));
          polyline = new kakao.maps.Polyline({
            path: path,
            strokeWeight: 6,
            strokeColor: "#ff3d00",
            strokeOpacity: 0.8,
          });
          polyline.setMap(map);
        }
        
        updateDistanceDisplay();
        checkIfCanGenerate();
      });

      // Ï∞çÏùÄ Ï†êÎßå ÏßÄÏö∞Í∏∞
      clearPointsBtn.addEventListener("click", () => {
        clearPoiMarkers();
        checkIfCanGenerate();
      });

      // Ï†ÑÏ≤¥ ÏßÄÏö∞Í∏∞
      clearAllBtn.addEventListener("click", () => {
        points = [];
        lineSegments = [];
        clearPoiMarkers();
        if (startMarker) {
          startMarker.setMap(null);
          startMarker = null;
        }
        if (polyline) {
          polyline.setMap(null);
          polyline = null;
        }
        startAddress = "";
        generatedLineString = null;
        totalDistanceM = 0;
        resultModal.classList.remove("show");
        applyBtn.disabled = true;
        updateDistanceDisplay();
        checkIfCanGenerate();
      });

      // Í≤ΩÎ°ú ÏÉùÏÑ±
      createRouteBtn.addEventListener("click", async () => {
        let source = [];

        // POI ÎßàÏª§Í∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ† ÏÇ¨Ïö©
        if (poiMarkers.length >= 2) {
          source = poiMarkers.map((m) => {
            const pos = m.getPosition();
            return { lat: pos.getLat(), lng: pos.getLng() };
          });
        } else if (points.length >= 2) {
          source = [...points];
        } else {
          alert("ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅÏùò Ï†êÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
          return;
        }

        // ÏôïÎ≥µ Î™®ÎìúÏùº Í≤ΩÏö∞ÏóêÎßå Ï∂úÎ∞úÏßÄÎ•º ÎßàÏßÄÎßâÏóê Ï∂îÍ∞Ä
        if (roundTripMode) {
          const startPoint = source[0];
          const lastPoint = source[source.length - 1];
          
          // ÎßàÏßÄÎßâ Ï†êÍ≥º Ï∂úÎ∞úÏßÄÍ∞Ä 10m Ïù¥ÏÉÅ Îñ®Ïñ¥Ï†∏ ÏûàÏúºÎ©¥ Ï∂úÎ∞úÏßÄ Ï∂îÍ∞Ä
          const distToStart = haversine(lastPoint, startPoint);
          if (distToStart > 10) {
            source.push({ lat: startPoint.lat, lng: startPoint.lng });
          }
        }

        showLoading();

        try {
          // ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
          const token = localStorage.getItem("accessToken");
          const headers = {
            "Content-Type": "application/json",
          };

          if (token) {
            headers["Authorization"] = token.startsWith("Bearer ")
              ? token
              : `Bearer ${token}`;
          }

          const viaPoints = source.map((p) => ({ lat: p.lat, lng: p.lng }));
          const payload = {
            startLat: viaPoints[0].lat,
            startLng: viaPoints[0].lng,
            viaPoints: viaPoints,
          };

          const response = await fetch(API_BASE + "/api/courses/oneway", {
            method: "POST",
            headers: headers,
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error("Í≤ΩÎ°ú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          }

          const data = await response.json();

          if (!data?.lineString || data.lineString.length < 2) {
            throw new Error("Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
          }

          generatedLineString = data.lineString;
          totalDistanceM =
            data.totalDistance ||
            calcDistance(
              generatedLineString.map(([lng, lat]) => ({ lat, lng }))
            );

          if (totalDistanceM > MAX_DISTANCE_M) {
            alert(
              "42.195kmÎ•º Ï¥àÍ≥ºÌïòÎäî ÏΩîÏä§Îäî ÎßåÎì§ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Í≤ΩÎ°úÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî."
            );
            generatedLineString = null;
            totalDistanceM = 0;
            applyBtn.disabled = true;
            return;
          }

          // ÏÉùÏÑ±Îêú Í≤ΩÎ°úÎ•º pointsÏóê Ï†ÄÏû•
          points = generatedLineString.map(([lng, lat]) => ({ lat, lng }));

          // ÏãúÏûë Ï£ºÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
          if (points.length > 0) {
            startAddress = await reverseGeocode(points[0].lat, points[0].lng);
            if (startMarker) startMarker.setMap(null);
            startMarker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(points[0].lat, points[0].lng),
              map: map,
            });
          }

          // Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞
          drawPolyline(points);

          // Ï†ÅÏö© Î≤ÑÌäº ÌôúÏÑ±Ìôî
          applyBtn.disabled = false;

          // Í≤∞Í≥º Î™®Îã¨ ÌëúÏãú
          document.getElementById("modalDistance").textContent =
            (totalDistanceM / 1000).toFixed(2) + " km";
          document.getElementById("modalPoints").textContent =
            points.length + "Í∞ú";
          document.getElementById("modalStart").textContent =
            startAddress || "Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå";
          resultModal.classList.add("show");
        } catch (error) {
          console.error(error);
          alert(error.message || "Í≤ΩÎ°ú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        } finally {
          hideLoading();
        }
      });

      // Îã§Ïãú Í∑∏Î¶¨Í∏∞
      cancelBtn.addEventListener("click", () => {
        resultModal.classList.remove("show");
        generatedLineString = null;
        totalDistanceM = 0;
        applyBtn.disabled = true;
      });

      // Ï†ÅÏö© Î≤ÑÌäº
      applyBtn.addEventListener("click", () => {
        if (!generatedLineString || points.length < 2) {
          alert("Í≤ΩÎ°ú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
          return;
        }

        const payload = {
          path: {
            type: "LineString",
            coordinates: generatedLineString,
          },
          distanceM: Math.round(totalDistanceM),
          startLat: points[0].lat,
          startLng: points[0].lng,
          address: startAddress || "",
          courseRegisterType: "MANUAL",
        };

        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        const returnPage =
          sessionStorage.getItem("returnPage") || "/courseCreate";
        sessionStorage.removeItem("returnPage");
        window.location.href = returnPage;
      });
    </script>
  
</body>
</html>
