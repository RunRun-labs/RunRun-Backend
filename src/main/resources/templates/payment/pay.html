<!-- ìœ„ì¹˜: src/main/resources/templates/payment/pay.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©¤ë²„ì‹­ ê²°ì œ</title>
    <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            padding-bottom: 80px;
        }

        .header {
            background-color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .back-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .header-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .container {
            padding: 20px;
        }

        .plan-card {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .plan-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .plan-price {
            font-size: 28px;
            font-weight: bold;
            float: right;
            margin-top: -32px;
        }

        .plan-period {
            color: #666;
            font-size: 14px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .payment-method-btn {
            width: 100%;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .agreements {
            margin-bottom: 24px;
        }

        .agreement-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
        }

        .agreement-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .coupon-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .coupon-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .coupon-input-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .coupon-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .apply-coupon-btn {
            padding: 12px 20px;
            background: #96e6a1;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .price-summary {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .price-row.total {
            border-top: 1px solid #e0e0e0;
            margin-top: 12px;
            padding-top: 16px;
            font-weight: bold;
            font-size: 16px;
        }

        .discount {
            color: #ff4444;
        }

        .payment-btn {
            width: 100%;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        .payment-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 12px;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
<!-- í—¤ë” -->
<div class="header">
    <button class="back-btn" onclick="history.back()">â†</button>
    <div class="header-title">ë©¤ë²„ì‹­ ê²°ì œ</div>
    <div style="width: 24px;"></div>
</div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<div class="container">
    <!-- í”Œëœ ì •ë³´ -->
    <div class="plan-card">
        <div class="plan-title">í”„ë¦¬ë¯¸ì—„ í”Œëœ</div>
        <div class="plan-price">9,900ì›</div>
        <div class="plan-period">1ê°œì›” êµ¬ë…</div>
    </div>

    <!-- ê²°ì œ ìˆ˜ë‹¨ -->
    <div class="section-title">ê²°ì œ ìˆ˜ë‹¨</div>
    <button class="payment-method-btn">í† ìŠ¤í˜ì´</button>

    <!-- ì•½ê´€ ë™ì˜ -->
    <div class="agreements">
        <label class="agreement-item">
            <input type="checkbox" id="agree-terms">
            <span>ì´ìš©ì•½ê´€ ë™ì˜ (í•„ìˆ˜)</span>
        </label>
        <label class="agreement-item">
            <input type="checkbox" id="agree-privacy">
            <span>ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ë™ì˜ (í•„ìˆ˜)</span>
        </label>
        <label class="agreement-item">
            <input type="checkbox" id="agree-auto">
            <span>ìë™ê²°ì œ ë™ì˜ (í•„ìˆ˜)</span>
        </label>
    </div>

    <!-- ì¿ í° ì„¹ì…˜ -->
    <div class="coupon-section">
        <div class="coupon-title">ì¿ í°</div>
        <div class="coupon-input-wrapper">
            <input type="text" id="coupon-code" class="coupon-input" placeholder="ì‚¬ìš© ê°€ëŠ¥ ì¿ í° 1ì¥">
            <button class="apply-coupon-btn" onclick="applyCoupon()">ì¿ í° ì‚¬ìš©í•˜ê¸° â€º</button>
        </div>
    </div>

    <!-- ê°€ê²© ìš”ì•½ -->
    <div class="price-summary">
        <div class="price-row">
            <span>ìƒí’ˆ ê¸ˆì•¡</span>
            <span id="original-price">9,900ì›</span>
        </div>
        <div class="price-row">
            <span>ì¿ í° í• ì¸</span>
            <span id="coupon-discount" class="discount">-0ì›</span>
        </div>
        <div class="price-row total">
            <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
            <span id="final-price">9,900ì›</span>
        </div>
    </div>

    <!-- ê²°ì œí•˜ê¸° ë²„íŠ¼ -->
    <button class="payment-btn" id="payment-btn">ë©¤ë²„ì‹­ ê²°ì œí•˜ê¸°</button>
</div>

<!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="bottom-nav">
    <a href="/chat" class="nav-item">
        <div class="nav-icon">ğŸ’¬</div>
        <div>chat</div>
    </a>
    <a href="/crews" class="nav-item">
        <div class="nav-icon">ğŸ‘¥</div>
        <div>crew</div>
    </a>
    <a href="/" class="nav-item">
        <div class="nav-icon">ğŸ </div>
        <div>home</div>
    </a>
    <a href="/match/select" class="nav-item">
        <div class="nav-icon">âš¡</div>
        <div>match</div>
    </a>
    <a href="/myPage" class="nav-item">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>my</div>
    </a>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const accessToken = localStorage.getItem('accessToken');

    let finalAmount = 9900;
    let couponCode = null;

    // ì¿ í° ì ìš©
    function applyCoupon() {
        couponCode = document.getElementById('coupon-code').value;
        if (!couponCode || couponCode.trim() === '') {
            alert('ì¿ í° ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        const discountAmount = 9900;
        finalAmount = 0;

        document.getElementById('coupon-discount').textContent = '-' + discountAmount.toLocaleString() + 'ì›';
        document.getElementById('final-price').textContent = finalAmount.toLocaleString() + 'ì›';

        alert('ì¿ í° ì ìš© ì™„ë£Œ!');
    }

    // í† ìŠ¤í˜ì´ë¨¼ì¸  v2 SDK ì´ˆê¸°í™”
    const clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq';
    const tossPayments = TossPayments(clientKey);
    let payment = null;


    // ë©¤ë²„ì‹­ ê²°ì œí•˜ê¸° ë²„íŠ¼
    document.getElementById('payment-btn').addEventListener('click', async () => {
        // ì•½ê´€ ì²´í¬
        if (!document.getElementById('agree-terms').checked ||
            !document.getElementById('agree-privacy').checked ||
            !document.getElementById('agree-auto').checked) {
            alert('ëª¨ë“  ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”');
            return;
        }

        try {
            console.log('ê²°ì œ ìš”ì²­ ì‹œì‘...');

            // 1. orderId ìƒì„±
            const response = await fetch('/api/payments/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    amount: finalAmount,
                    couponCode: couponCode
                })
            });

            const result = await response.json();
            if (!result.success) {
                alert('ê²°ì œ ìš”ì²­ ì‹¤íŒ¨: ' + result.message);
                return;
            }

            const orderId = result.data.orderId;
            const amount = result.data.amount;

            const customerKeyFromServer = result.data.customerKey;
            payment = tossPayments.payment({customerKey: customerKeyFromServer});

            console.log('orderId:', orderId);

            // 2. ìë™ê²°ì œìš© ì¹´ë“œ ë“±ë¡ (ë¹Œë§í‚¤ ë°œê¸‰)
            await payment.requestBillingAuth({
                method: 'CARD',
                successUrl: window.location.origin + '/payment/success?orderId=' + orderId + '&amount=' + amount,
                failUrl: window.location.origin + '/payment/fail',
                customerEmail: result.data.customerEmail || 'test@runrun.com',
                customerName: result.data.customerName || 'ëŸ°ëŸ°íšŒì›'
            });

        } catch (error) {
            console.error('ì—ëŸ¬:', error);
            alert('ê²°ì œ ì‹¤íŒ¨: ' + error.message);
        }
    });
    /*]]>*/
</script>
</body>
</html>
