<!-- 위치: src/main/resources/templates/payment/pay.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>멤버십 결제</title>
    <!-- 토스페이먼츠 SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <!-- bottom-nav CSS 추가 -->
    <link rel="stylesheet" href="/css/home.css" th:href="@{/css/home.css}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            padding-bottom: 80px;
            overflow-y: auto;
            height: 100vh;
        }

        .header {
            background-color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .back-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .header-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .container {
            padding: 20px;
            padding-bottom: 120px;
            overflow-y: auto;
        }

        .plan-card {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .plan-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .plan-price {
            font-size: 28px;
            font-weight: bold;
            float: right;
            margin-top: -32px;
        }

        .plan-period {
            color: #666;
            font-size: 14px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .payment-method-btn {
            width: 100%;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .agreements {
            margin-bottom: 24px;
        }

        .agreement-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
        }

        .agreement-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .coupon-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .coupon-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .coupon-input-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .coupon-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .apply-coupon-btn {
            padding: 12px 20px;
            background: #96e6a1;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .price-summary {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .price-row.total {
            border-top: 1px solid #e0e0e0;
            margin-top: 12px;
            padding-top: 16px;
            font-weight: bold;
            font-size: 16px;
        }

        .discount {
            color: #ff4444;
        }

        .payment-btn {
            width: 100%;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 100px;
        }

        .payment-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<!-- 헤더 -->
<div class="header">
    <button class="back-btn" onclick="history.back()">←</button>
    <div class="header-title">멤버십 결제</div>
    <div style="width: 24px;"></div>
</div>

<!-- 메인 컨텐츠 -->
<div class="container">
    <!-- 플랜 정보 -->
    <div class="plan-card">
        <div class="plan-title">프리미엄 플랜</div>
        <div class="plan-price">9,900원</div>
        <div class="plan-period">1개월 구독</div>
    </div>

    <!-- 결제 수단 -->
    <div class="section-title">결제 수단</div>
    <button class="payment-method-btn">토스페이</button>

    <!-- 약관 동의 -->
    <div class="agreements">
        <label class="agreement-item">
            <input type="checkbox" id="agree-terms">
            <span>이용약관 동의 (필수)</span>
        </label>
        <label class="agreement-item">
            <input type="checkbox" id="agree-privacy">
            <span>개인정보 처리방침 동의 (필수)</span>
        </label>
        <label class="agreement-item">
            <input type="checkbox" id="agree-auto">
            <span>자동결제 동의 (필수)</span>
        </label>
    </div>

    <!-- 쿠폰 섹션 -->
    <div class="coupon-section">
        <div class="coupon-title">쿠폰</div>
        <div class="coupon-input-wrapper">
            <input type="text" id="coupon-code" class="coupon-input"
                   placeholder="쿠폰을 선택해주세요" readonly>
            <button class="apply-coupon-btn" onclick="goToCouponPage()">
                쿠폰 사용하기 ›
            </button>
        </div>
        <div id="selected-coupon-info" style="display: none; margin-top: 12px; color: #666;">
            <p>선택된 쿠폰: <span id="selected-coupon-name"></span></p>
            <p>할인 혜택: <span id="selected-coupon-benefit"></span></p>
            <p id="coupon-notice" style="margin-top: 8px; font-size: 12px;"></p>

            <button onclick="removeCoupon()" style="color: #ff4444; background: none; border: none; cursor: pointer;">
                쿠폰 제거
            </button>
        </div>
    </div>

    <!-- 가격 요약 -->
    <div class="price-summary">
        <div class="price-row">
            <span>상품 금액</span>
            <span id="original-price">9,900원</span>
        </div>
        <div class="price-row">
            <span>쿠폰 할인</span>
            <span id="coupon-discount" class="discount">-0원</span>
        </div>
        <div class="price-row total">
            <span>최종 결제 금액</span>
            <span id="final-price">9,900원</span>
        </div>
    </div>

    <!-- 결제하기 버튼 -->
    <button class="payment-btn" id="payment-btn">멤버십 결제하기</button>
</div>

<!-- 하단 네비게이션 -->
<div th:replace="~{common/bottom-nav :: bottomNav}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const accessToken = localStorage.getItem('accessToken');

    let finalAmount = 9900;
    let couponCode = null;

    // 쿠폰 페이지로 이동
    function goToCouponPage() {
        localStorage.setItem('paymentReturnUrl', '/payment/pay');
        window.location.href = '/coupon/my';
    }

    // 쿠폰 선택 완료 후 돌아왔을 때
    window.addEventListener('load', async function () {
        // 사용 가능한 쿠폰 개수 조회
        await loadAvailableCouponCount();
        const selectedCoupon = localStorage.getItem('selectedCoupon');
        if (selectedCoupon) {
            const coupon = JSON.parse(selectedCoupon);
            applyCouponFromSelection(coupon);
        } else {
            resetCouponSelection();
        }
    });

    // 쿠폰 선택 초기화 함수
    function resetCouponSelection() {
        couponCode = null;
        finalAmount = 9900;

        document.getElementById('coupon-code').value = '';
        document.getElementById('selected-coupon-info').style.display = 'none';
        document.getElementById('coupon-discount').textContent = '-0원';
        document.getElementById('final-price').textContent = '9,900원';

        // 쿠폰 안내 문구도 초기화
        const noticeElement = document.getElementById('coupon-notice');
        if (noticeElement) {
            noticeElement.innerHTML = '';
        }
    }

    // 사용 가능한 쿠폰 개수 조회 함수
    async function loadAvailableCouponCount() {
        try {
            const response = await fetch('/api/coupon-issues?size=100&benefitTypes=FIXED_DISCOUNT,RATE_DISCOUNT,EXPERIENCE',
                {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

            if (!response.ok) {
                console.error('쿠폰 조회 실패');
                return;
            }

            const result = await response.json();
            if (result.success && result.data && result.data.items) {
                // 결제에 사용 가능한 쿠폰만 필터링
                const availableCoupons = result.data.items.filter(coupon =>
                    coupon.benefitType === 'FIXED_DISCOUNT' ||
                    coupon.benefitType === 'RATE_DISCOUNT' ||
                    coupon.benefitType === 'EXPERIENCE'
                );

                const count = availableCoupons.length;
                const inputElement = document.getElementById('coupon-code');

                if (count > 0) {
                    inputElement.placeholder = `사용 가능 쿠폰 ${count}장`;
                } else {
                    inputElement.placeholder = '사용 가능한 쿠폰이 없습니다';
                }
            }
        } catch (error) {
            console.error('쿠폰 개수 조회 중 오류:', error);
            // 오류 발생 시 기본 문구 유지
            document.getElementById('coupon-code').placeholder = '쿠폰을 선택해주세요';
        }
    }

    // 선택된 쿠폰 적용
    function applyCouponFromSelection(coupon) {
        couponCode = coupon.code;
        document.getElementById('coupon-code').value = coupon.code;
        document.getElementById('selected-coupon-name').textContent = coupon.name;
        document.getElementById('selected-coupon-benefit').textContent = formatBenefit(coupon);
        document.getElementById('selected-coupon-info').style.display = 'block';

        const noticeElement = document.getElementById('coupon-notice');
        if (coupon.benefitType === 'EXPERIENCE') {
            // 체험권
            noticeElement.innerHTML = '⚠️ <span style="color: #ff6b00;">체험권은 기간 종료 후 자동 해지됩니다. 계속 이용하시려면 재구독해주세요.</span>';
        } else if (coupon.benefitType === 'FIXED_DISCOUNT' || coupon.benefitType === 'RATE_DISCOUNT') {
            // 할인권
            noticeElement.innerHTML = 'ℹ️ <span style="color: #666;">해당 할인권은 첫 달 할인이 적용되며, 다음 달부터 정상가(9,900원)로 자동결제됩니다.</span>';
        } else {
            noticeElement.innerHTML = '';
        }

        // 할인 금액 적용
        const discountAmount = calculateDiscountAmount(coupon);
        finalAmount = 9900 - discountAmount;

        document.getElementById('coupon-discount').textContent = '-' + discountAmount.toLocaleString() + '원';
        document.getElementById('final-price').textContent = finalAmount.toLocaleString() + '원';

        // 선택된 쿠폰 정보 제거 (한 번만 사용)
        localStorage.removeItem('selectedCoupon');
    }

    // 쿠폰 제거
    function removeCoupon() {
        couponCode = null;
        finalAmount = 9900;

        document.getElementById('coupon-code').value = '';
        document.getElementById('selected-coupon-info').style.display = 'none';
        document.getElementById('coupon-discount').textContent = '-0원';
        document.getElementById('final-price').textContent = '9,900원';

        const noticeElement = document.getElementById('coupon-notice');
        if (noticeElement) {
            noticeElement.innerHTML = '';
        }

        localStorage.removeItem('selectedCoupon');
    }

    // 혜택 포맷팅
    function formatBenefit(coupon) {
        if (coupon.benefitType === 'FIXED_DISCOUNT') {
            return coupon.benefitValue.toLocaleString() + '원 할인';
        } else if (coupon.benefitType === 'RATE_DISCOUNT') {
            return coupon.benefitValue + '% 할인';
        } else if (coupon.benefitType === 'EXPERIENCE') {
            return coupon.benefitValue + '일 무료 체험';
        }
        return '할인';
    }

    // 할인 금액 계산
    function calculateDiscountAmount(coupon) {
        const originalAmount = 9900;

        if (coupon.benefitType === 'FIXED_DISCOUNT') {
            return Math.min(coupon.benefitValue, originalAmount);
        } else if (coupon.benefitType === 'RATE_DISCOUNT') {
            return Math.floor((originalAmount * coupon.benefitValue) / 100);
        } else if (coupon.benefitType === 'EXPERIENCE') {
            return originalAmount; // 100% 할인
        }
        return 0;
    }

    // 토스페이먼츠 v2 SDK 초기화
    const clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq';
    const tossPayments = TossPayments(clientKey);
    let payment = null;


    // 멤버십 결제하기 버튼
    document.getElementById('payment-btn').addEventListener('click', async () => {
        // 약관 체크
        if (!document.getElementById('agree-terms').checked ||
            !document.getElementById('agree-privacy').checked ||
            !document.getElementById('agree-auto').checked) {
            alert('모든 약관에 동의해주세요');
            return;
        }

        try {
            console.log('결제 요청 시작...');

            // 1. orderId 생성
            const response = await fetch('/api/payments/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    amount: finalAmount,
                    couponCode: couponCode
                })
            });

            const result = await response.json();
            if (!result.success) {
                alert('결제 요청 실패: ' + result.message);
                return;
            }

            const orderId = result.data.orderId;
            const amount = result.data.amount;

            const customerKeyFromServer = result.data.customerKey;
            payment = tossPayments.payment({customerKey: customerKeyFromServer});

            console.log('orderId:', orderId);

            if (amount === 0) {
                localStorage.setItem('freePaymentOrderId', orderId);
                window.location.href = `/payment/free-success`;
                return;
            }

            // 2. 자동결제용 카드 등록 (빌링키 발급)
            await payment.requestBillingAuth({
                method: 'CARD',
                successUrl: window.location.origin + '/payment/success?orderId=' + orderId + '&amount=' + amount,
                failUrl: window.location.origin + '/payment/fail',
                customerEmail: result.data.customerEmail || 'test@runrun.com',
                customerName: result.data.customerName || '런런회원'
            });

        } catch (error) {
            console.error('에러:', error);
            alert('결제 실패: ' + error.message);
        }
    });
    /*]]>*/
</script>
</body>
</html>
