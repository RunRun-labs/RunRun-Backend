<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ê²°ì œ ì²˜ë¦¬ì¤‘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .processing-container {
            background: white;
            border-radius: 24px;
            padding: 48px 32px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #96e6a1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
        }

        .message {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
        }

        .dots {
            display: inline-block;
        }

        .dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '';
            }
            40% {
                content: '.';
            }
            60% {
                content: '..';
            }
            80%, 100% {
                content: '...';
            }
        }
    </style>
</head>
<body>
<div class="processing-container">
    <div class="icon">ğŸƒâ€â™‚ï¸</div>
    <div class="spinner"></div>
    <h1 class="title">ê²°ì œ ì²˜ë¦¬ì¤‘<span class="dots"></span></h1>
    <p class="message">
        ë©¤ë²„ì‹­ êµ¬ë…ì„ ì²˜ë¦¬í•˜ê³  ìˆì–´ìš”<br>
        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
    </p>
</div>

<script>
    const params = new URLSearchParams(location.search);

    const orderId = params.get("orderId");
    const amount = params.get("amount");
    const customerKey = params.get("customerKey");
    const authKey = params.get("authKey");

    const accessToken = localStorage.getItem("accessToken");

    // í† í° í™•ì¸
    if (!accessToken) {
        alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        location.href = "/login";
        throw new Error("No accessToken");
    }

    const amountParam = params.get("amount");
    // í•„ìˆ˜ ê°’ í™•ì¸
    if (!orderId || amountParam === null || !customerKey || !authKey) {
        alert("ê²°ì œ ì¸ì¦ ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        console.log({orderId, amount, customerKey, authKey});
    } else {
        fetch("/api/payments/billing/confirm", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                orderId,
                amount: Number(amountParam),
                customerKey,
                authKey
            })
        })
            .then(r => r.json())
            .then(res => {
                if (!res.success) throw new Error(res.message);
                localStorage.removeItem('selectedCoupon');
                alert("ğŸƒâ€â™‚ï¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ êµ¬ë… ì™„ë£Œ!\në” ìŠ¤ë§ˆíŠ¸í•œ ëŸ¬ë‹, ì§€ê¸ˆ ì‹œì‘í•´ë³´ì„¸ìš”.");
                location.href = "/membership";
            })
            .catch(err => {
                console.error(err);
                alert("êµ¬ë… ì²˜ë¦¬ ì‹¤íŒ¨: " + err.message);
                location.href = "/payment/fail";
            });
    }
</script>
</body>
</html>