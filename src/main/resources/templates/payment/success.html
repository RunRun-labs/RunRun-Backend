<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ê²°ì œ ì²˜ë¦¬ì¤‘...</title>
</head>
<body>
<h3>ê²°ì œ ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</h3>

<script>
    const params = new URLSearchParams(location.search);

    const orderId = params.get("orderId");
    const amount = params.get("amount");
    const customerKey = params.get("customerKey");
    const authKey = params.get("authKey");

    const accessToken = localStorage.getItem("accessToken");

    // í† í° í™•ì¸
    if (!accessToken) {
        alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        location.href = "/login";
        throw new Error("No accessToken");
    }

    const amountParam = params.get("amount");
    // í•„ìˆ˜ ê°’ í™•ì¸
    if (!orderId || amountParam === null || !customerKey || !authKey) {
        alert("ê²°ì œ ì¸ì¦ ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        console.log({orderId, amount, customerKey, authKey});
    } else {
        fetch("/api/payments/billing/confirm", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                orderId,
                amount: Number(amountParam),
                customerKey,
                authKey
            })
        })
            .then(r => r.json())
            .then(res => {
                if (!res.success) throw new Error(res.message);
                alert("ğŸƒâ€â™‚ï¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ êµ¬ë… ì™„ë£Œ!\në” ìŠ¤ë§ˆíŠ¸í•œ ëŸ¬ë‹, ì§€ê¸ˆ ì‹œì‘í•´ë³´ì„¸ìš”.");
                location.href = "/membership";
            })
            .catch(err => {
                console.error(err);
                alert("êµ¬ë… ì²˜ë¦¬ ì‹¤íŒ¨: " + err.message);
                location.href = "/payment/fail";
            });
    }
</script>
</body>
</html>
